name: Test Slack Notifications

on:
  workflow_dispatch:
    inputs:
      slack-channel:
        description: "Slack channel to post to (e.g., #development)"
        required: true
        default: "#development"
      test-tag:
        description: "Tag to use for release template test (e.g., v1.0.0)"
        required: false
        default: "v3.4.1"

permissions:
  contents: read # Required for fetching tags and commits for contributors feature

env:
  SVC_NAME: ios-sdk
  ACTION_VERSION: ENG-1105-testing # Change this to test a specific branch or tag (e.g., 'main', 'v1.0.0', 'feature-branch')

jobs:
  test-custom-template:
    name: Test Custom Template
    runs-on: ubuntu-latest
    steps:
      - name: Post Custom Notification
        uses: Neuro-ID/actions/slack-notification@ENG-1105-testing
        with:
          slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel: ${{ github.event.inputs.slack-channel }}
          template: custom
          title: Custom Template Test
          message: |
            This is a test of the *custom template*.

            Features:
            ‚Ä¢ Simple, clean layout
            ‚Ä¢ Markdown formatting support
            ‚Ä¢ Auto-populated footer with context

  test-workflow-success:
    name: Test Workflow Success Template
    runs-on: ubuntu-latest
    steps:
      - name: Simulate Successful Workflow
        run: echo "‚úÖ Workflow completed successfully"

      - name: Post Workflow Success Notification
        uses: Neuro-ID/actions/slack-notification@ENG-1105-testing
        with:
          slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel: ${{ github.event.inputs.slack-channel }}
          template: workflow-success
          title: Workflow Success Test
          message: |
            Test workflow completed successfully! 

            All tests passed ‚úì
            Build artifacts created ‚úì
            Deployment ready ‚úì

  test-workflow-failure:
    name: Test Workflow Failure Template
    runs-on: ubuntu-latest
    steps:
      - name: Simulate Failed Step
        run: echo "‚ùå Simulating a failed step"

      - name: Post Workflow Failure Notification
        uses: Neuro-ID/actions/slack-notification@ENG-1105-testing
        with:
          slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel: ${{ github.event.inputs.slack-channel }}
          template: workflow-failure
          title: Workflow Failure Test
          message: |
            Test workflow failed during deployment step.

            Error: Connection timeout to database
            Please check the logs for more details.

  test-release-template:
    name: Test Release Template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for tags

      - name: Post Release Review Notification
        uses: Neuro-ID/actions/slack-notification@ENG-1105-testing
        with:
          slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel: ${{ github.event.inputs.slack-channel }}
          template: release
          title: Release Template Test
          message: |
            Release ready for review and deployment.

            *What's New:*
            ‚Ä¢ Added GitHub contributors feature
            ‚Ä¢ Added thread reply support
            ‚Ä¢ Improved error handling
          template-data: '{"tag": "${{ github.event.inputs.test-tag }}"}'
          # github-token defaults to ${{ github.token }} automatically

  test-threading:
    name: Test Thread Replies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Post Initial Release Notification
        id: initial-notification
        uses: Neuro-ID/actions/slack-notification@ENG-1105-testing
        with:
          slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel: ${{ github.event.inputs.slack-channel }}
          template: release
          title: Thread Test - Release
          message: "Testing threaded replies feature. Watch for follow-up messages in this thread!"
          template-data: '{"tag": "${{ github.event.inputs.test-tag }}"}'
          # github-token defaults to ${{ github.token }} automatically

      - name: Wait for initial message
        run: sleep 2

      - name: Simulate Deployment Process
        run: |
          echo "üì¶ Building application..."
          sleep 2
          echo "üöÄ Deploying to staging..."
          sleep 2
          echo "‚úÖ Deployment complete!"

      - name: Post Deployment Progress (Thread Reply 1)
        uses: Neuro-ID/actions/slack-notification@ENG-1105-testing
        with:
          slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel: ${{ github.event.inputs.slack-channel }}
          template: custom
          title: Deployment Started
          message: "üì¶ Building and deploying to staging environment..."
          thread-ts: ${{ fromJson(steps.initial-notification.outputs.results)[0].ts }}

      - name: Wait between messages
        run: sleep 2

      - name: Post Deployment Success (Thread Reply 2)
        uses: Neuro-ID/actions/slack-notification@ENG-1105-testing
        with:
          slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel: ${{ github.event.inputs.slack-channel }}
          template: workflow-success
          title: Deployment Complete
          message: |
            ‚úÖ Successfully deployed to staging!

            *Environment:* Staging
            *Version:* ${{ github.event.inputs.test-tag }}
            *Status:* Healthy
          thread-ts: ${{ fromJson(steps.initial-notification.outputs.results)[0].ts }}

  test-multiple-channels:
    name: Test Multiple Channels
    runs-on: ubuntu-latest
    if: contains(github.event.inputs.slack-channel, ',')
    steps:
      - name: Post to Multiple Channels
        uses: Neuro-ID/actions/slack-notification@ENG-1105-testing
        with:
          slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel: ${{ github.event.inputs.slack-channel }}
          template: custom
          title: Multi-Channel Test
          message: |
            Testing multi-channel posting feature.

            This message was posted to multiple channels simultaneously!

  test-custom-bot-appearance:
    name: Test Custom Bot Appearance
    runs-on: ubuntu-latest
    steps:
      - name: Post with Custom Bot
        uses: Neuro-ID/actions/slack-notification@ENG-1105-testing
        with:
          slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel: ${{ github.event.inputs.slack-channel }}
          template: custom
          title: Custom Bot Test
          message: "This message uses a custom bot name and icon!"
          username: "Test Bot ü§ñ"
          icon: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      - test-custom-template
      - test-workflow-success
      - test-workflow-failure
      - test-release-template
      - test-threading
      - test-custom-bot-appearance
    if: always()
    steps:
      - name: Post Summary
        uses: Neuro-ID/actions/slack-notification@ENG-1105-testing
        with:
          slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel: ${{ github.event.inputs.slack-channel }}
          template: custom
          title: Test Suite Complete
          message: |
            üéâ Slack notification test suite completed!

            *Tests Run:*
            ‚Ä¢ Custom Template: ${{ needs.test-custom-template.result }}
            ‚Ä¢ Workflow Success: ${{ needs.test-workflow-success.result }}
            ‚Ä¢ Workflow Failure: ${{ needs.test-workflow-failure.result }}
            ‚Ä¢ Release Template: ${{ needs.test-release-template.result }}
            ‚Ä¢ Thread Replies: ${{ needs.test-threading.result }}
            ‚Ä¢ Custom Bot: ${{ needs.test-custom-bot-appearance.result }}

            Check the messages above to verify all templates rendered correctly.
